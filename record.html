<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ—¥å ±è¨˜éŒ²ä¸€è¦§</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f9f9f9;
      padding: 20px;
    }
    h2 {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .controls {
      margin-bottom: 10px;
    }
    .record-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 10px;
    }
    .record {
      background: white;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 0 4px rgba(0,0,0,0.1);
      page-break-inside: avoid;
    }
    .record--empty {
      opacity: 0.4;
    }
    .missing-end {
      color: orange;
      font-weight: bold;
    }
    select {
      margin-right: 10px;
    }

    @media print {
      body {
        background-color: white;
        padding: 0;
      }
      .record-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }
      .controls, h2 a {
        display: none;
      }
    }
  </style>
</head>
<body>
  <h2>
    æ—¥å ±è¨˜éŒ²ä¸€è¦§
    <a href="daily_report.html">â† æ—¥å ±å…¥åŠ›ã«æˆ»ã‚‹</a>
  </h2>

  <div class="controls">
    è¡¨ç¤ºã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š
    <select id="userSelect"></select>
    æœˆï¼š
    <select id="monthSelect"></select>
    <button onclick="window.print()">ğŸ–¨ PDFã¨ã—ã¦ä¿å­˜</button>
  </div>

  <div id="recordList" class="record-grid"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import {
      getFirestore, collection, getDocs, query, where
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC_ZkD7YXmyfmAYvLuFm_3AC1Le_KlMlSg",
      authDomain: "log-ndailyreportpass.firebaseapp.com",
      projectId: "log-ndailyreportpass",
      storageBucket: "log-ndailyreportpass.appspot.com",
      messagingSenderId: "1024080463078",
      appId: "1:1024080463078:web:12315db475df67d5f32727",
      measurementId: "G-GF8QKM2PY1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const currentUser = sessionStorage.getItem("userEmail");
    if (!currentUser) {
      alert("ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
      location.href = "login.html";
    }

    const userSelect = document.getElementById("userSelect");
    const monthSelect = document.getElementById("monthSelect");
    const recordList = document.getElementById("recordList");

    // æœˆã‚»ãƒ¬ã‚¯ãƒˆç”Ÿæˆ
    for (let i = 0; i < 12; i++) {
      const date = new Date();
      date.setMonth(i);
      const option = document.createElement("option");
      option.value = `${date.getFullYear()}-${String(i + 1).padStart(2, "0")}`;
      option.textContent = `${date.getFullYear()}å¹´${i + 1}æœˆ`;
      monthSelect.appendChild(option);
    }

    monthSelect.value = new Date().toISOString().slice(0, 7);

    async function loadEmails() {
      const snap = await getDocs(collection(db, "reports"));
      const emails = new Set();
      snap.forEach(doc => emails.add(doc.data().email));
      [...emails].sort().forEach(email => {
        const option = document.createElement("option");
        option.value = email;
        option.textContent = email + (email === currentUser ? "ï¼ˆè‡ªåˆ†ï¼‰" : "");
        userSelect.appendChild(option);
      });
      userSelect.value = currentUser;
      loadRecords();
    }

    async function loadRecords() {
      recordList.innerHTML = "";

      const selectedEmail = userSelect.value;
      const selectedMonth = monthSelect.value;
      const [year, month] = selectedMonth.split("-").map(Number);
      const daysInMonth = new Date(year, month, 0).getDate();
      const startDateStr = `${year}å¹´${String(month).padStart(2, "0")}æœˆ`;
      const q = query(collection(db, "reports"), where("email", "==", selectedEmail));
      const snap = await getDocs(q);

      const dataMap = {};
      snap.forEach(doc => {
        const data = doc.data();
        if (data.date.startsWith(startDateStr)) {
          dataMap[data.date] = data;
        }
      });

      for (let d = 1; d <= daysInMonth; d++) {
        const dateStr = `${year}å¹´${String(month).padStart(2, "0")}æœˆ${String(d).padStart(2, "0")}æ—¥`;
        const record = dataMap[dateStr];
        const div = document.createElement("div");
        div.className = "record" + (record ? "" : " record--empty");

        if (record) {
          const taskHtml = (record.tasks || [])
            .map(t => `ãƒ»${t.project} / ${t.detail} / ${t.duration}h`)
            .join("<br>");
          div.innerHTML = `
            <div>${record.date}</div>
            <div>å‡ºå‹¤: ${record.start || "--"}</div>
            <div>é€€å‹¤: ${record.end || "<span class='missing-end'>æœªé€€å‹¤</span>"}</div>
            <div>ä¼‘æ†©: ${record.break || "--"}æ™‚é–“</div>
            <div>ä½“èª¿: ${record.condition || "--"}</div>
            <div>å®Ÿåƒ: ${record.start && record.end ? calcHours(record.start, record.end, record.break) : "--"}</div>
            ${taskHtml}
          `;
        } else {
          div.innerHTML = `
            <div>${dateStr}</div>
            <div>å‡ºå‹¤: --</div>
            <div>é€€å‹¤: --</div>
            <div>ä¼‘æ†©: --æ™‚é–“</div>
            <div>ä½“èª¿: --</div>
            <div>å®Ÿåƒ: --</div>
          `;
        }

        recordList.appendChild(div);
      }
    }

    function calcHours(start, end, breakTime = 0) {
      const [sh, sm] = start.split(":").map(Number);
      const [eh, em] = end.split(":").map(Number);
      const s = new Date(0, 0, 0, sh, sm);
      const e = new Date(0, 0, 0, eh, em);
      const diff = (e - s) / 3600000 - parseFloat(breakTime || 0);
      return diff.toFixed(2) + "æ™‚é–“";
    }

    userSelect.onchange = loadRecords;
    monthSelect.onchange = loadRecords;

    loadEmails();
  </script>
</body>
</html>
