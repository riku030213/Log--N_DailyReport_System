<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>日報記録（Firestore版）</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f9f9f9;
      padding: 20px;
    }
    .record-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 15px;
    }
    .record {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .record.empty {
      background: #eee;
      color: #888;
    }
    .date {
      font-weight: bold;
    }
    .missing-end {
      color: orange;
      font-weight: bold;
    }
    a {
      text-decoration: none;
      color: #007BFF;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <h2>日報記録一覧（Firestore版）　<a href="daily_report.html">← 日報入力に戻る</a></h2>
  <div id="recordList" class="record-grid"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC_ZkD7YXmyfmAYvLuFm_3AC1Le_KlMlSg",
      authDomain: "log-ndailyreportpass.firebaseapp.com",
      projectId: "log-ndailyreportpass",
      storageBucket: "log-ndailyreportpass.appspot.com",
      messagingSenderId: "1024080463078",
      appId: "1:1024080463078:web:12315db475df67d5f32727",
      measurementId: "G-GF8QKM2PY1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function loadFirestoreRecords() {
      const userEmail = sessionStorage.getItem("userEmail");
      if (!userEmail) {
        alert("ログイン情報がありません。ログインしてください。");
        window.location.href = "login.html";
        return;
      }

      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth() + 1;
      const daysInMonth = new Date(year, month, 0).getDate();

      const list = document.getElementById("recordList");
      list.innerHTML = "";

      const q = query(collection(db, "reports"), where("email", "==", userEmail));
      const snapshot = await getDocs(q);
      const recordMap = {};

      snapshot.forEach(doc => {
        const data = doc.data();
        recordMap[data.date] = data;
      });

      for (let d = 1; d <= daysInMonth; d++) {
        const dateStr = `${year}年${String(month).padStart(2, '0')}月${String(d).padStart(2, '0')}日`;
        const r = recordMap[dateStr];
        const div = document.createElement("div");
        div.className = "record" + (r ? "" : " empty");

        if (r) {
          div.innerHTML = `
            <div class="date">${r.date}</div>
            <div>出勤: ${r.start || "--"}</div>
            <div>退勤: ${r.end || "<span class='missing-end'>未退勤</span>"}</div>
            <div>休憩: ${r.break || "--"}時間</div>
            <div>体調: ${r.condition || "--"}</div>
            <div>実働: ${
              r.start && r.end ? calcWorkingHours(r.start, r.end, r.break) + "時間" : "--"
            }</div>
            ${r.tasks ? r.tasks.map(t => `<div>・${t.project} / ${t.detail} / ${t.duration}h</div>`).join("") : ""}
          `;
        } else {
          div.innerHTML = `
            <div class="date">${dateStr}</div>
            <div>出勤: --</div>
            <div>退勤: --</div>
            <div>休憩: --時間</div>
            <div>体調: --</div>
            <div>実働: --</div>
          `;
        }

        list.appendChild(div);
      }
    }

    function calcWorkingHours(start, end, breakTime) {
      const [sh, sm] = start.split(":").map(Number);
      const [eh, em] = end.split(":").map(Number);
      const startDate = new Date(0, 0, 0, sh, sm);
      const endDate = new Date(0, 0, 0, eh, em);
      let diff = (endDate - startDate) / (1000 * 60 * 60);
      diff -= parseFloat(breakTime || 0);
      return diff.toFixed(2);
    }

    loadFirestoreRecords();
  </script>
</body>
</html>
