<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>日報編集</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
    }
    .form-section {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 700px;
      margin: auto;
    }
    .task-entry {
      margin-bottom: 10px;
      padding: 10px;
      border: 1px dashed #ccc;
      border-radius: 5px;
    }
    .error {
      color: red;
      font-size: 0.9em;
    }
    select, input, textarea {
      width: 100%;
      margin-bottom: 10px;
    }
    .header-flex {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
  </style>
</head>
<body>
  <div class="form-section">
    <div class="header-flex">
      <h2 id="pageTitle">日報編集</h2>
      <label>
        編集日付：
        <select id="editDate"></select>
      </label>
    </div>

    <label for="breakTime">休憩時間（時間単位）:</label>
    <input list="breakOptions" id="breakTime" />
    <datalist id="breakOptions">
      <option value="0"><option value="0.5"><option value="1"><option value="1.5">
      <option value="2"><option value="2.5"><option value="3"><option value="3.5"><option value="4">
    </datalist>

    <label for="condition">体調:</label>
    <select id="condition">
      <option value="">-- 未入力 --</option>
      <option value="好調">好調</option>
      <option value="普通">普通</option>
      <option value="不調">不調</option>
    </select>

    <div id="noteField" style="display:none">
      <label for="note">備考（体調が不調の場合）:</label>
      <textarea id="note" rows="2" style="resize: vertical;"></textarea>
    </div>

    <h3>作業詳細</h3>
    <div id="taskContainer"></div>
    <button type="button" id="addTaskButton">＋ 作業を追加</button>

    <button id="saveButton">編集を保存</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC_ZkD7YXmyfmAYvLuFm_3AC1Le_KlMlSg",
      authDomain: "log-ndailyreportpass.firebaseapp.com",
      projectId: "log-ndailyreportpass",
      storageBucket: "log-ndailyreportpass.appspot.com",
      messagingSenderId: "1024080463078",
      appId: "1:1024080463078:web:12315db475df67d5f32727",
      measurementId: "G-GF8QKM2PY1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentUserEmail = null;

    function formatDateDisplay(date) {
      return `${date.getFullYear()}年${String(date.getMonth() + 1).padStart(2, "0")}月${String(date.getDate()).padStart(2, "0")}日`;
    }

    function parseDateFromQuery() {
      const params = new URLSearchParams(location.search);
      return params.get("date") || formatDateDisplay(new Date());
    }

    function populateDateSelect(selected) {
      const editDateSelect = document.getElementById("editDate");
      editDateSelect.innerHTML = "";
      const today = new Date();
      const y = today.getFullYear();
      const m = today.getMonth();
      for (let d = 1; d <= 31; d++) {
        const date = new Date(y, m, d);
        if (date.getMonth() !== m) break;
        const str = formatDateDisplay(date);
        const opt = document.createElement("option");
        opt.value = str;
        opt.textContent = str;
        if (str === selected) opt.selected = true;
        editDateSelect.appendChild(opt);
      }
    }

    function clearTaskUI() {
      document.getElementById("taskContainer").innerHTML = "";
    }

    function fillForm(data) {
      document.getElementById("breakTime").value = data.break || "";
      document.getElementById("condition").value = data.condition || "";
      document.getElementById("note").value = data.note || "";
      document.getElementById("noteField").style.display = data.condition === "不調" ? "block" : "none";

      clearTaskUI();
      (data.tasks || []).forEach(task => {
        const container = document.getElementById("taskContainer");
        const div = document.createElement("div");
        div.className = "task-entry";
        div.innerHTML = `
          <label>案件名:</label><input type="text" name="project" value="${task.project || ''}"><br>
          <label>作業内容:</label><textarea name="task" rows="1" style="width: 100%; resize: none; overflow: hidden;">${task.detail || ''}</textarea><br>
          <label>作業時間（h）:</label><input type="number" name="duration" step="0.1" min="0" value="${task.duration || ''}">
        `;
        container.appendChild(div);
      });
    }

    async function loadReport(email, dateDisplay) {
      const docRef = doc(db, "reports", `${email}_${dateDisplay}`);
      const snap = await getDoc(docRef);
      if (snap.exists()) {
        fillForm(snap.data());
      } else {
        clearTaskUI();
      }
    }

    document.getElementById("editDate").addEventListener("change", async (e) => {
      const selectedDate = e.target.value;
      history.replaceState(null, "", `?date=${selectedDate}`);
      await loadReport(currentUserEmail, selectedDate);
    });

//step2

    document.getElementById("saveButton").addEventListener("click", async () => {
      if (!currentUserEmail) return alert("ログイン状態を確認してください。");

      const dateDisplay = document.getElementById("editDate").value;
      const docId = `${currentUserEmail}_${dateDisplay}`;
      const docRef = doc(db, "reports", docId);
      const snap = await getDoc(docRef);
      const oldData = snap.exists() ? snap.data() : {};

      // 編集内容の取得
      const breakTime = document.getElementById("breakTime").value;
      const condition = document.getElementById("condition").value;
      const note = document.getElementById("note").value;

      const taskEls = document.querySelectorAll(".task-entry");
      const tasks = [...taskEls].map(entry => {
        return {
          project: entry.querySelector("input[name='project']").value,
          detail: entry.querySelector("textarea[name='task']").value,
          duration: parseFloat(entry.querySelector("input[name='duration']").value || 0)
        };
      });

      const newData = {
        ...oldData,
        break: breakTime,
        condition,
        note,
        tasks,
        edited: true,
        editHistory: [
          ...(oldData.editHistory || []),
          `編集前: ${JSON.stringify({ break: oldData.break, condition: oldData.condition, note: oldData.note, tasks: oldData.tasks })}`
        ]
      };

      await setDoc(docRef, newData);
      alert("編集内容を保存しました。\n稼働表に反映されます。");
    });


    onAuthStateChanged(auth, async (user) => {
      if (!user) return alert("ログイン情報が見つかりません");
      currentUserEmail = user.email;
      const targetDate = parseDateFromQuery();
      populateDateSelect(targetDate);
      await loadReport(currentUserEmail, targetDate);
    });

    document.getElementById("condition").addEventListener("change", () => {
      const cond = document.getElementById("condition").value;
      document.getElementById("noteField").style.display = cond === "不調" ? "block" : "none";
    });

    document.getElementById("addTaskButton").addEventListener("click", () => {
      const container = document.getElementById("taskContainer");
      const div = document.createElement("div");
      div.className = "task-entry";
      div.innerHTML = `
        <label>案件名:</label><input type="text" name="project"><br>
        <label>作業内容:</label><textarea name="task" rows="1" style="width: 100%; resize: none; overflow: hidden;"></textarea><br>
        <label>作業時間（h）:</label><input type="number" name="duration" step="0.1" min="0">
      `;
      container.appendChild(div);

      const textarea = div.querySelector("textarea[name='task']");
      textarea.addEventListener("input", () => {
        textarea.style.height = "auto";
        textarea.style.height = textarea.scrollHeight + "px";
      });
    });
  </script>
</body>
</html>
